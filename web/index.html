<head>
  <style> body { margin: 0; } </style>

  <script src="//unpkg.com/3d-force-graph"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <link rel="stylesheet" href="css/index.css">

</head>

<body>

<form id="pid-tid-selection">
  <label for="pid">PID to analyse:</label>
  <select id="pid-selection" name="pid">
    <option value="none">None</option>
  </select>
  <label for="tid">TID to analyse:</label>
  <select id="tid-selection" name="tid" disabled>
    <option value="none">None</option>
  </select>
</form>


<div id="plot">

  <div id="graph-plot"></div>
  <div id="more-details">
    <p>test</p>
  </div>

</div>

<script type="module">

/* 
 * Graph definition
 */

const params = {
  linkOpacity: 0.6,
  frequencySensitivity: 0.7
};

function createGraph(elem, filename)
{
  let graph = ForceGraph3D()(elem)
    .jsonUrl(filename)
    .linkDirectionalArrowLength(10)
    .linkDirectionalArrowRelPos(0.5)
    .enableNodeDrag(false)
    .linkWidth(link => 1/params.frequencySensitivity * Math.log(link.count) + 1)
    .linkOpacity(params.linkOpacity)
    .onNodeClick(node => console.log(node));

  graph.controls().dynamicDampingFactor = 0.8; // Make controls crisp

  return graph;
}

/* 
 * TID selection UI2
 */

let pids_tid_map;
let pid_select = document.getElementById("pid-selection");
let tid_select = document.getElementById("tid-selection");

$.getJSON( "gen/pid_tid_map.json", function( data ) {
  pids_tid_map = data;
  for (let pid in data) {
    let option_str = pid.toString();
    let pid_option = document.createElement("option");
    pid_option.setAttribute("value", option_str);
    pid_option.textContent += option_str;
    pid_select.appendChild(pid_option);
  }
})

pid_select.addEventListener("change", function() {
    let pid = pid_select.value;

    if (pid === "none") {
      tid_select.setAttribute("disabled", true);
      tid_select.value = "none"
      return;
    }

    while (tid_select.childElementCount != 1) {
      tid_select.removeChild(tid_select.lastChild);
    }
    let tids = pids_tid_map[pid];
    for (let tid of tids) {
      let option_str = tid.pin_tid.toString() + ": " + tid.os_tid.toString()
      let tid_option = document.createElement("option");
      tid_option.setAttribute("value", tid.pin_tid.toString());
      tid_option.textContent += option_str;
      tid_select.appendChild(tid_option);
    }
    tid_select.removeAttribute('disabled');
});

const params = {
  linkOpacity: 0.6,
  frequencySensitivity: 0.7
};

function createGraph(elem, filename)
{
  let colour_link = "green"; // Color of the links that denote access to non-whitelisted areas
  let graph = ForceGraph3D()(elem)
    .jsonUrl(filename)
    .linkDirectionalArrowLength(10)
    .linkDirectionalArrowRelPos(0.5)
    .enableNodeDrag(false)
    .linkWidth(link => 1/params.frequencySensitivity * Math.log(link.count) + 1)
    .linkOpacity(params.linkOpacity)
    .linkCurvature(link => (link.target == link.source) ? 1 : 0)
    .linkColor(link => (link.hasOwnProperty('non_white')) ? colour_link : 0)
    .nodeLabel(node => node.rtn_called);

  graph.controls().dynamicDampingFactor = 0.8; // Make controls crisp
  return graph;
}

var graph;
tid_select.addEventListener("change", function() {

  if (tid_select.value == "none") {
    return;
  }

  let pid = pid_select.value;
  let pin_tid = tid_select.value;
  let os_tid;
  for (let tid of pids_tid_map[pid]) {
    if (tid.pin_tid == pin_tid) {
      os_tid = tid.os_tid;
      break;
    }
  }

  let elem = document.getElementById('graph-plot');
  let filename = "gen/pid" + pid.toString() +
    "_tid" + os_tid.toString() +
    "_ptid" + pin_tid.toString() +
    ".json";

  graph = createGraph(elem, filename);
})

/* 
 * GUI for graph
 */

import { GUI } from 'https://threejs.org/examples/jsm/libs/dat.gui.module.js';

const gui = new GUI();
gui.add(params, "linkOpacity", 0.0, 1.0).onChange(
  val => graph.linkOpacity(Number(val)));
gui.add(params, "frequencySensitivity", 0.0, 1.0).onChange(
  val => graph.linkWidth(link => 1/Number(val) * Math.log(link.count) + 1))
gui.close();

</script>
</body>